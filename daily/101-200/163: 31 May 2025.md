# Log 163: Two Bugs and a Path

> 31 May 2025

## What I Worked On:

- [Reverted](https://github.com/lightningdevkit/rust-lightning/pull/3639#issuecomment-2924804538)
  iterator-based changes in `Flow`
- Continued implementing the alternate Dummy Hop
  [approach](https://github.com/shaavan/rust-lightning/commits/dummy-10)

## Reflections:

Today brought two very different puzzles — one about cleanup, and the other
about complexity.

First, I noticed a few CI tests started failing after the latest round of `Flow`
changes. Tracing the issue led me to the recent switch from returning a `Vec` of
peers to returning an iterator. While it felt like a nice abstraction at the
time, it began violating locking order assumptions — holding locks longer than
they should’ve been. I tried manually collecting the iterator in a few
problematic spots, but that just cancelled out the original benefit. So I
reverted the change — and sure enough, the CI issues vanished.

With Flow stabilized again, I turned to the Dummy Hops work — specifically,
addressing
[this comment](https://github.com/lightningdevkit/rust-lightning/pull/3726#discussion_r2109702042)
about authenticating only the **first** dummy hop. Sounds simple — but
implementing it revealed deeper architectural questions.

We now have two conceptual types of dummy hops: **Primary** (with
authentication) and **Subsequent** (unauthenticated). Should we model them as an
`enum`? That introduces decoding complexity in a part of the codebase where we
don’t typically rely on enums. Two separate structs? They’re still the same
fundamental type — is that clean?

And then there’s decoding logic: how do you **ensure** the first dummy hop is a
`Primary`, and that all `Subsequent`s follow it appropriately? How do you
prevent rogue `Subsequent` hops from sneaking in? Pattern matching helps — but
it’s not enough unless enforced structurally or through sequence checks.

It’s a subtle challenge — not hard per se, but full of design tension. I’ve
peeled a few layers, but some still remain. That will be tomorrow’s puzzle.

For now, I’ll rest — satisfied with what got done, and curious about what’s
ahead.
