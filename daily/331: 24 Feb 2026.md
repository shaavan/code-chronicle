# Log 331: Locking the Check

> 24 Feb 2026

## What I Worked On

- [Introduced] currency validation during invoice request handling

## Reflections

Today was fully focused on currency handling.

The primary goal was to introduce currency correctness checks after parsing a
received `InvoiceRequest`. The challenge here is structural: at parse time, we
don’t have access to a `CurrencyConversion`, so we can’t immediately validate
whether the requested amount is correct.

That raised a more important question: how do we ensure the check is _never_
missed?

The approach I settled on was to move the validation to the point where the
response `Bolt12Invoice` amount is set. By enforcing the check there, we make it
structurally impossible to respond to an invoice request without validating the
amount. The invariant becomes part of the flow, not a best-effort check.

Once that fell into place, the overall currency approach started to look
coherent from the outside. The pieces finally feel like they belong to a single
shape.

In discussion with my mentor, we also identified an important edge case around
**static invoices**. Since static invoices can be long-lived, the fiat-to-msats
conversion rate may drift between invoice creation and payment, potentially
leading to stale amounts. After identifying this risk, I reached out to a
colleague working on static invoices to get further insight.

A good day of design work, with a few important questions surfaced for the next
iteration.

[Introduced]: https://github.com/shaavan/rust-lightning/commits/currency-48
